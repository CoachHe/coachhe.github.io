在深入探索流处理的基础知识之前，我们需要先介绍Dataflow编程的必要背景。

# Dataflow图

## 先决了解

Dataflow是数据流，源自于谷歌非常著名的论文。本节就是较为基础地讲解了Dataflow的知识，并且需要知道的是，Flink就是基本按照那篇论文的架构来进行实现的。

## Dataflow介绍

顾名思义，Dataflow程序描述了数据如何在不同操作之间流动。Dataflow程序通常表示为**有向图**。

图中**顶点为算子**，表示**计算**；而**边表示数据依赖关系**。

### 算子

算子是Dataflow程序的基本功能单元，它们从输入获取数据，对其进行计算，然后产生数据并发往输出以供后续处理。没有输入端的算子称为**数据源**，没有输出端的算子称为**数据汇**。

一个Dataflow图至少要有一个数据源和一个数据汇。下图展示了一个从推文输入流中提取并统计主题标签的Dataflow程序。

<img src="https://coachhe.oss-cn-shenzhen.aliyuncs.com/Flink/20201213220929.png" style="zoom: 50%;" />

图中的Tweets source是数据源，也就是没有输入端的算子（自身就是输入端）。Trending topics sink为数据汇，也就是没有输出端的算子（自身就是最终节点）。中间的Extract hashtags和Count就是普通算子。

## 逻辑Dataflow图和物理Dataflow图

类似上图2-1称为**逻辑Dataflow图**，因为它们表达了高层视角下的计算逻辑。

为了执行Dataflow程序，需要将逻辑Dataflow图转化为**物理Dataflow图**，后者会指定程序的执行细节。

<img src="https://coachhe.oss-cn-shenzhen.aliyuncs.com/Flink/20201213220954.png" style="zoom: 50%;" />

#### 逻辑Dataflow图和物理Dataflow图的区别

在逻辑Dataflow图中，顶点代表**算子**。

在物理Dataflow图中，顶点代表**任务**。

以图2-1为例，顶点推文数据源的下一个顶点是抽取主题标签，代表的是一个算子，也就是一类型的任务。而图2-2中顶点推文数据源中的下一个顶点为两个抽取主题标签，”抽取主题标签“算起包含两个并行算子任务，每个任务负责计算一部分输入数据。

# 数据并行和任务并行

Dataflow图的并行性可以通过多种方式加以利用。

###### 数据并行

将输入数据分组，让同一操作的多个任务并行执行在不同数据子集上，这种并行称为数据并行。

###### 任务并行

让不同算子的任务并行计算，这种并行称为任务并行

###### 总结

数据并行就是同一个任务的数据并行进行计算，任务并行就是不同任务并行进行。

# 数据交换策略

数据交换策略定义了如何将数据项分配给物理Dataflow中的不同任务。

分为转发策略，广播策略，基于键值策略和随机策略。分别表示如下：

<img src="https://coachhe.oss-cn-shenzhen.aliyuncs.com/Flink/20201213221018.png" style="zoom: 33%;" />

1. 转发策略：发送端任务和接收端任务之间一对一进行数据传输。
2. 广播策略：会把每个任务项发往下游算子的全部并行任务。代价较为昂贵。
3. 基于键值的策略：基于某一键值属性对数据分区，并保证键值相同的项会进入同一个任务处理。
4. 随机策略：会将数据均匀分配给所有任务。

# 并行流处理

## 数据流的定义

数据流是一个可能无限的时间序列。

由于数据流没有总执行时间的概念，因此我们用延迟和吞吐来表示系统的性能。

## 延迟

延迟表示处理一个事件所需要的时间。

#### 延迟的分类

延迟分为平均延迟，最大延迟和延迟的百分位数值。例如95百分位在10ms表示有95%的数据会在10ms内被处理。

## 吞吐

吞吐是用来衡量系统处理能力的指标，它告诉我们系统每单位时间能处理多少事件。

### 数据流上的操作

#### 窗口

1. 滚动窗口

   将事件分配到长度固定且互不重叠的桶中。

   <img src="https://coachhe.oss-cn-shenzhen.aliyuncs.com/Algorithm/20201213193956.png" style="zoom:33%;" />

   ​																				基于数量的滚动窗口

   <img src="https://coachhe.oss-cn-shenzhen.aliyuncs.com/Flink/20201213195451.png" style="zoom:33%;" />

   ​																					基于时间的滚动窗口

2. 滑动窗口

   将事件分配到大小固定且允许相互冲切的桶中，这意味着每个事件可能会同时属于多个桶。

   <img src="https://coachhe.oss-cn-shenzhen.aliyuncs.com/Flink/20201213195734.png" style="zoom: 33%;" />

   ​													长度为4个事件滑动间隔为3个事件的基于数量的滑动窗口

3. 会话窗口

   能将属于同一会话的时间分配到相同桶中。会话窗口根据会话间隔将事件分为不同的会话，改间隔值定义了会话在关闭前的非活动时间长度。

   <img src="https://coachhe.oss-cn-shenzhen.aliyuncs.com/Flink/20201213201043.png" style="zoom:33%;" />

   ​																						会话窗口

# 时间语义

## 处理时间

处理时间是当前**流处理算子所在机器**上本地时钟时间。

也就是说，若某个人离线之后再重新连接，离线的那段时间并不是处理时间，因为他并没有和算子所在机器取得联系。

<img src="https://coachhe.oss-cn-shenzhen.aliyuncs.com/Flink/20201213221100.png" style="zoom:50%;" />

可以看到，不会将离线时间考虑在内。

## 事件时间

事件时间是数据流中事件实际发生的时间，它以**附加在数据流中事件的时间戳**为依据。如下图所示，即便有事件延迟，事件时间窗口也能准确地将事件分配到窗口中，从而反映出真实发生的情况。

<img src="https://coachhe.oss-cn-shenzhen.aliyuncs.com/Flink/20201213221119.png" style="zoom:50%;" />

事件时间将处理速度和结果内容彻底解耦。要客服的挑战之一是如何处理延迟事件。

## 水位线



水位线是一个全局进度指标，表示我们确信不再有延迟事件到来的某个时间点。

本质上，水位线提供了一个**逻辑时钟**，用来通知系统**当前的事件时间**。

#### 水位线的意义

当一个算子接收到时间为T的水位线，就可以认为不会再收到任何时间戳小于或等于T的事件了。也就是说，算子一旦收到某个水位线，就相当于接到信号：某个特定时间区间的时间戳已经到齐，可以出发窗口计算或对接收的数据进行排序了。

## 事件时间和处理时间

事件时间虽然能解决所有问题，但是处理时间窗口能够将延迟降到最低。无需考虑迟到或者乱序。对于那些更重视处理速度而非准确度的应用，处理时间就会派上用场。





















